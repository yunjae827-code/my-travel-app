import streamlit as st
import requests
from streamlit_folium import st_folium
import folium

# --- [ì„¤ì •] ë³¸ì¸ì˜ API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš” ---
GOOGLE_API_KEY = "YOUR_GOOGLE_MAPS_API_KEY"
WEATHER_API_KEY = "YOUR_OPENWEATHER_API_KEY"

st.set_page_config(page_title="ìŠ¤ë§ˆíŠ¸ íŠ¸ë˜ë¸” í”Œë˜ë„ˆ", layout="wide", page_icon="ğŸ“")

# ì•± ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ë„ì°©ì§€ ì €ì¥ìš©)
if 'selected_destination' not in st.session_state:
    st.session_state.selected_destination = None

st.title("ğŸ“ ì§€ëŠ¥í˜• ì¥ì†Œ ê²€ìƒ‰ ë° ê°€ì´ë“œ")

# ë ˆì´ì•„ì›ƒ ë¶„í• 
col1, col2 = st.columns([2, 1])

with col1:
    st.subheader("ğŸ—ºï¸ ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”")
    
    # ì´ˆê¸° ì§€ë„ ì„¤ì • (ì„œìš¸ ì¤‘ì‹¬)
    m = folium.Map(location=[37.5665, 126.9780], zoom_start=14)
    
    # ì§€ë„ í´ë¦­ ì‹œ ì¢Œí‘œ íŒì—…
    m.add_child(folium.LatLngPopup())

    # 1. ì£¼ë³€ ì¸ê¸° ì¥ì†Œ(ì‹ë‹¹ ë“±) ê°€ì ¸ì˜¤ê¸° (ì˜ˆì‹œë¡œ ì„œìš¸ ì¤‘ì‹¬ 1km ë°˜ê²½)
    # ì‹¤ì œë¡œëŠ” ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë³€í•˜ê²Œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
    places_url = f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=37.5665,126.9780&radius=1000&type=restaurant&key={GOOGLE_API_KEY}"
    places_res = requests.get(places_url).json()

    if places_res.get('results'):
        for place in places_res['results'][:10]:
            name = place['name']
            p_lat = place['geometry']['location']['lat']
            p_lng = place['geometry']['location']['lng']
            rating = place.get('rating', 'í‰ì  ì—†ìŒ')
            
            # ë§ˆì»¤ í´ë¦­ ì‹œ ë‚˜íƒ€ë‚  íŒì—…ì°½ ë””ìì¸
            popup_html = f"""
                <div style='width:150px'>
                    <b>{name}</b><br>
                    í‰ì : â­{rating}<br><br>
                    <small>ì§€ë„ í•˜ë‹¨ 'ì •ë³´ í™•ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë„ì°©ì§€ë¡œ ì„¤ì •í•˜ì„¸ìš”.</small>
                </div>
            """
            folium.Marker(
                [p_lat, p_lng], 
                tooltip=name, 
                popup=folium.Popup(popup_html, max_width=200),
                icon=folium.Icon(color='red', icon='cutlery')
            ).add_to(m)

    # ì§€ë„ í‘œì‹œ
    map_data = st_folium(m, width=800, height=500)

# í´ë¦­ ë°ì´í„° ì²˜ë¦¬
clicked_lat, clicked_lon = None, None
if map_data.get("last_object_clicked"):
    clicked_lat = map_data["last_object_clicked"]["lat"]
    clicked_lon = map_data["last_object_clicked"]["lng"]
elif map_data.get("last_clicked"):
    clicked_lat = map_data["last_clicked"]["lat"]
    clicked_lon = map_data["last_clicked"]["lng"]

with col2:
    st.subheader("â„¹ï¸ ì¥ì†Œ ìƒì„¸ ì •ë³´")
    
    if clicked_lat and clicked_lon:
        # ì—­ì§€ì˜¤ì½”ë”© (ì¢Œí‘œë¡œ ì£¼ì†Œ ì°¾ê¸°)
        rev_geo_url = f"https://maps.googleapis.com/maps/api/geocode/json?latlng={clicked_lat},{clicked_lon}&key={GOOGLE_API_KEY}&language=ko"
        rev_res = requests.get(rev_geo_url).json()
        
        if rev_res['status'] == 'OK':
            address = rev_res['results'][0]['formatted_address']
            st.write(f"ğŸ  **ì„ íƒëœ ì£¼ì†Œ:**\n{address}")
            
            if st.button("ğŸš© ì´ê³³ì„ ë„ì°©ì§€ë¡œ ì„¤ì •"):
                st.session_state.selected_destination = {"lat": clicked_lat, "lon": clicked_lon, "address": address}

        # ì„ íƒëœ ëª©ì ì§€ê°€ ìˆì„ ê²½ìš° ë‚ ì”¨ ë° ê²½ë¡œ ìš”ì•½ í‘œì‹œ
        if st.session_state.selected_destination:
            dest = st.session_state.selected_destination
            
            # ë‚ ì”¨ ì •ë³´
            w_url = f"https://api.openweathermap.org/data/2.5/weather?lat={dest['lat']}&lon={dest['lon']}&appid={WEATHER_API_KEY}&units=metric&lang=kr"
            w_res = requests.get(w_url).json()
            
            st.markdown("---")
            st.info(f"âœ… **ëª©ì ì§€ í™•ì •:** {dest['address']}")
            
            w_col1, w_col2 = st.columns(2)
            with w_col1:
                st.metric("ì˜¨ë„", f"{w_res['main']['temp']}Â°C")
            with w_col2:
                st.write(f"ê¸°ìƒ: {w_res['weather'][0]['description']}")
            
            # ì´ë™ íŒ
            st.write("ğŸš— **ì´ë™ íŒ:** í˜„ì¬ ìœ„ì¹˜ì—ì„œ í•´ë‹¹ ì§€ì ê¹Œì§€ì˜ ìµœì  ê²½ë¡œë¥¼ íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤...")
    else:
        st.write("ì§€ë„ì—ì„œ ë§ˆì»¤(ì‹ë‹¹ ë“±)ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë¹ˆ ê³µê°„ì„ í´ë¦­í•´ ë³´ì„¸ìš”.")